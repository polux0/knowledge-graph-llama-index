name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create .env file on server
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP_ADDRESS }} << 'EOF'

          # Ensure required directories exist and set permissions
          mkdir -p /usr/share/snapshots/elasticsearch $HOME/es_snapshots/ $HOME/neo4j/data $HOME/neo4j/logs $HOME/neo4j/import $HOME/neo4j/plugins $HOME/chroma-data $HOME/esdata1 $HOME/redis $HOME/nebula/data/meta0 $HOME/nebula/logs/meta0 $HOME/nebula/data/storage0 $HOME/nebula/logs/storage0 $HOME/nebula/logs/graph
          # Set permissions for Elasticsearch snapshots
          chmod -R 777 /usr/share/snapshots/elasticsearch $HOME/es_snapshots
          # chown -R root:root $HOME/elasticsearch/snapshots $HOME/neo4j $HOME/chroma-data $HOME/esdata1
          chown -R 1000:1000 $HOME/es_snapshots $HOME/neo4j $HOME/chroma-data $HOME/esdata1
          # Make snapshot scripts executable
          chmod +x /home/auravana/app/scripts/elasticsearch/create_snapshot.sh /home/auravana/app/scripts/elasticsearch/setup_repository.sh /home/auravana/app/scripts/elasticsearch/create_snapshot_with_cleanup.sh /home/auravana/app/scripts/elasticsearch/restore_from_a_snapshot.sh

          cat <<EOT > /home/auravana/app/.env
          HUGGING_FACE_API_KEY=${{ secrets.HUGGING_FACE_API_KEY }}
          HUGGING_FACE_API_KEY_ANOTHER=${{ secrets.HUGGING_FACE_API_KEY_ANOTHER }}
          NEO4J_DATABASE=${{ secrets.NEO4J_DATABASE }}
          NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}
          NEO4J_URL=${{ secrets.NEO4J_URL }}
          NEO4J_USERNAME=${{ secrets.NEO4J_USERNAME }}
          OPENAI_API_KEY=${{secrets.OPENAI_API_KEY}}
          CHROMA_URL=${{ secrets.CHROMA_URL }}
          CHROMA_PORT=${{secrets.CHROMA_PORT}}
          ELASTIC_SCHEME=${{secrets.ELASTIC_SCHEME}}
          ELASTIC_URL=${{ secrets.ELASTIC_URL }}
          ELASTIC_PORT=${{secrets.ELASTIC_PORT}}
          NEBULA_URL=${{ secrets.NEBULA_URL }}
          NEBULA_PORT=${{ secrets.NEBULA_PORT }}
          NEBULA_USERNAME=${{ secrets.NEBULA_USERNAME }}
          NEBULA_PASSWORD=${{ secrets.NEBULA_PASSWORD }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          COHERE_API_KEY=${{ secrets.COHERE_API_KEY}}
          ENV=${{ secrets.ENV}}
          EOT
          EOF
        continue-on-error: true

      - name: Deploy to Digital Ocean
        run: |
          ssh -v -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP_ADDRESS }} << 'EOF'
            export HUGGING_FACE_API_KEY=${{ secrets.HUGGING_FACE_API_KEY }}
            export HUGGING_FACE_API_KEY_ANOTHER=${{ secrets.HUGGING_FACE_API_KEY_ANOTHER }}
            export NEO4J_DATABASE=${{ secrets.NEO4J_DATABASE }}
            export NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}
            export NEO4J_URL=${{ secrets.NEO4J_URL }}
            export NEO4J_USERNAME=${{ secrets.NEO4J_USERNAME }}
            export OPENAI_API_KEY=${{secrets.OPENAI_API_KEY}}
            export CHROMA_URL=${{ secrets.CHROMA_URL }}
            export CHROMA_PORT=${{secrets.CHROMA_PORT}}
            export ELASTIC_SCHEME=${{secrets.ELASTIC_SCHEME}}
            export ELASTIC_URL=${{ secrets.ELASTIC_URL }}
            export ELASTIC_PORT=${{secrets.ELASTIC_PORT}}
            export NEBULA_URL=${{ secrets.NEBULA_URL }}
            export NEBULA_PORT=${{ secrets.NEBULA_PORT }}
            export NEBULA_USERNAME=${{ secrets.NEBULA_USERNAME }}
            export NEBULA_PASSWORD=${{ secrets.NEBULA_PASSWORD }}
            export REDIS_URL=${{ secrets.REDIS_URL }}
            export REDIS_PORT=${{ secrets.REDIS_PORT }}
            export REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            export COHERE_API_KEY=${{ secrets.COHERE_API_KEY}}
            export ENV=${{ secrets.ENV}}
            if [ ! -d "/home/auravana/app" ]; then
              # Clone the repository if the directory doesn't exist
              git clone https://github.com/polux0/knowledge-graph-llama-index /home/auravana/app
            else
              # Pull the latest changes if the repository is already cloned
              cd /home/auravana/app
              git pull
            fi
            cd /home/auravana/app
            docker-compose down && docker-compose up --build -d
          EOF

      - name: Deploy to Digital Ocean and set up cron job for Elasticsearch snapshots
        run: |
          ssh -v -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP_ADDRESS }} << 'EOF'
            # Setup repository for elasticsearch snapshots
            ./scripts/elasticsearch/setup_repository.sh
            # Remove existing cron jobs
            crontab -r || true
            # Set up cron job to create Elasticsearch snapshots every hour
            CRON_JOB="0 * * * * /home/auravana/app/scripts/elasticsearch/create_snapshot_with_cleanup.sh"
            echo "$CRON_JOB" | crontab -
          EOF

      - name: Set up Elasticsearch Schema
        run: |
          ssh -v -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP_ADDRESS }} << 'EOF'
            if [ -f /home/auravana/app/scripts/elasticsearch/setup.sh ] && [ -f /home/auravana/app/scripts/elasticsearch/migrations/01_add_source_agent_into_interaction.sh ]; then
                chmod +x /home/auravana/app/scripts/elasticsearch/setup.sh
                /home/auravana/app/scripts/elasticsearch/setup.sh
                chmod +x /home/auravana/app/scripts/elasticsearch/migrations/01_add_source_agent_into_interaction.sh
                /home/auravana/app/scripts/elasticsearch/migrations/01_add_source_agent_into_interaction.sh
            else
                echo "One or more Elasticsearch scripts not found"
                exit 1
            fi
          EOF
